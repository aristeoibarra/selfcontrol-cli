#!/bin/bash

# SelfControl CLI - Main Executable
# Production-ready command-line interface for SelfControl.app
# Version: 3.0.0

set -euo pipefail

# =============================================================================
# INITIALIZATION
# =============================================================================

# Determine script location
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

# Check if we're in development mode (lib directory exists relative to script)
if [[ -d "$ROOT_DIR/lib" && -f "$ROOT_DIR/lib/core.sh" ]]; then
    readonly LIB_DIR="$ROOT_DIR/lib"
else
    # Production mode - libraries are in ~/.local/lib/selfcontrol-cli
    readonly LIB_DIR="$HOME/.local/lib/selfcontrol-cli"
fi

# Source libraries
# shellcheck source=lib/core.sh
source "$LIB_DIR/core.sh"
# shellcheck source=lib/schedule.sh
source "$LIB_DIR/schedule.sh"

# Source LaunchAgent management (if available)
if [[ -f "$ROOT_DIR/scripts/launchagent.sh" ]]; then
    # shellcheck source=scripts/launchagent.sh
    source "$ROOT_DIR/scripts/launchagent.sh"
elif [[ -f "$HOME/.local/lib/selfcontrol-cli/launchagent.sh" ]]; then
    # shellcheck source=scripts/launchagent.sh
    source "$HOME/.local/lib/selfcontrol-cli/launchagent.sh"
fi

# =============================================================================
# COLOR CONSTANTS
# =============================================================================

readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly BOLD='\033[1m'
readonly NC='\033[0m'

# =============================================================================
# COMMAND FUNCTIONS
# =============================================================================

# Show help information
cmd_help() {
    cat << 'EOF'
SelfControl CLI - Automated Scheduled Blocking for macOS

USAGE:
    selfcontrol-cli <command> [options]

COMMANDS:
üìä Status & Information:
    status              Show current SelfControl and schedule status
    status --live       Live status monitoring with real-time updates
    info                Show detailed block information
    version             Show version and system information

üöÄ Block Management:
    start [minutes]       Start manual block (default: 120 minutes)

‚è∞ Schedule Management:
    schedule list       Show all configured schedules
    schedule status     Show current schedule status
    schedule enable <name>      Enable specific schedule
    schedule disable <name>     Disable specific schedule
    schedule reload     Reload configuration from file
    schedule test       Test schedule logic in real-time

üõ†Ô∏è Service Management (LaunchAgent):
    service status      Show LaunchAgent service status
    service start       Start (load) LaunchAgent service
    service stop        Stop (unload) LaunchAgent service
    service restart     Restart LaunchAgent service
    service logs [n]    Show LaunchAgent logs (default: 20 lines)
ü§ñ Service Management (v3.0.0):
    service status      Show LaunchAgent service status
    service start       Start LaunchAgent service
    service stop        Stop LaunchAgent service
    service restart     Restart LaunchAgent service
    service logs        Show LaunchAgent logs

üîß Utility:
    init                Initialize configuration and directories
    debug               Run comprehensive system diagnostics
    logs [--follow|-f]  Show or follow application logs
    validate            Validate configuration files

EXAMPLES:
    selfcontrol-cli start 240           # Block for 4 hours (240 minutes)
    selfcontrol-cli schedule list       # Show all schedules
    selfcontrol-cli schedule enable work_hours
    selfcontrol-cli schedule test       # Test schedule logic
    selfcontrol-cli service status      # Check LaunchAgent status
For more information, visit:
https://github.com/aristeoibarra/selfcontrol-cli
EOF
}

# Show version information
cmd_version() {
    echo "SelfControl CLI v$SELFCONTROL_CLI_VERSION"
    echo "Production-ready scheduled blocking for macOS"
    echo ""
    echo "SelfControl.app integration: $([ -x "$SELFCONTROL_CLI_PATH" ] && echo "‚úÖ Available" || echo "‚ùå Not found")"
    echo "Configuration: $([ -f "$SCHEDULE_CONFIG" ] && echo "‚úÖ Found" || echo "‚ùå Not found")"
    echo ""
    echo "Paths:"
    echo "  Root directory: $ROOT_DIR"
    echo "  Config file: $SCHEDULE_CONFIG"
    echo "  Log file: $SCHEDULE_LOG"
}

# Initialize SelfControl CLI
cmd_init() {
    echo "üöÄ Initializing SelfControl CLI..."
    echo ""

    # Create default configuration if it doesn't exist
    if [[ ! -f "$SCHEDULE_CONFIG" ]]; then
        local example_config="$ROOT_DIR/config/schedule.example.json"
        if [[ -f "$example_config" ]]; then
            cp "$example_config" "$SCHEDULE_CONFIG"
            echo "‚úÖ Created default configuration from example"
        else
            # Create minimal configuration
            cat > "$SCHEDULE_CONFIG" << 'JSON'
{
  "global_settings": {
    "check_interval": 5,
    "timezone": "auto",
    "prevent_duplicates": true,
    "log_level": "info"
  },
  "schedules": [],
  "blocklists": {
    "default": "blocklist.selfcontrol"
  },
  "logging": {
    "enabled": true,
    "max_size_mb": 10,
    "keep_days": 30
  }
}
JSON
            echo "‚úÖ Created minimal default configuration"
        fi
    fi

    # Create default blocklist if it doesn't exist
    local default_blocklist="$ROOT_DIR/config/blocklist.selfcontrol"
    if [[ ! -f "$default_blocklist" ]]; then
        local example_blocklist="$ROOT_DIR/config/blocklist.example.selfcontrol"
        if [[ -f "$example_blocklist" ]]; then
            cp "$example_blocklist" "$default_blocklist"
            echo "‚úÖ Created default blocklist from example"
        else
            echo "‚ö†Ô∏è  No default blocklist found. Please create: $default_blocklist"
        fi
    fi

    echo ""
    echo "üéâ SelfControl CLI initialized successfully!"
    echo ""
    echo "Next steps:"
    echo "1. Customize your schedule: $SCHEDULE_CONFIG"
    echo "2. Customize your blocklist: $default_blocklist"
    echo "3. Ensure LaunchAgent is running: selfcontrol-cli service status"
    echo "4. Test with 'selfcontrol-cli schedule test'"
}

# Quick status check
cmd_status() {
    if ! init_selfcontrol_cli; then
        die "Failed to initialize SelfControl CLI"
    fi

    if is_selfcontrol_running; then
            echo "üîí SelfControl: ACTIVE"

            # Get detailed info if available
            local settings
            if settings=$(get_selfcontrol_settings); then
                local end_date_utc
                end_date_utc=$(echo "$settings" | grep "BlockEndDate" | sed 's/.*"\([^"]*\)".*/\1/')

                if [[ -n "$end_date_utc" ]]; then
                    local end_timestamp now_timestamp
                    end_timestamp=$(date -j -f "%Y-%m-%d %H:%M:%S %z" "$end_date_utc" "+%s" 2>/dev/null)
                    now_timestamp=$(date "+%s")
                    local remaining_seconds=$((end_timestamp - now_timestamp))

                    if [[ $remaining_seconds -gt 0 ]]; then
                        local remaining_hours=$((remaining_seconds / 3600))
                        local remaining_minutes=$(((remaining_seconds % 3600) / 60))
                        echo "‚è∞ Remaining: ${remaining_hours}h ${remaining_minutes}m"
                    fi
                fi
            fi

            # Check if this was started by a schedule
            if [[ -f "$SCHEDULE_CONFIG" ]]; then
                local active_schedule
                if active_schedule=$(get_active_schedule 2>/dev/null); then
                    local schedule_name
                    schedule_name=$(json_get_value "$active_schedule" "name" "unknown")
                    echo "üìÖ Active schedule: $schedule_name"
                fi
            fi
    else
        echo "‚úÖ SelfControl: INACTIVE"
            # Check if there's an active schedule that should be running
            if [[ -f "$SCHEDULE_CONFIG" ]]; then
                local active_schedule
                if active_schedule=$(get_active_schedule 2>/dev/null); then
                    local schedule_name end_time remaining
                    schedule_name=$(json_get_value "$active_schedule" "name" "unknown")
                    end_time=$(json_get_value "$active_schedule" "end_time" "")
                    remaining=$(get_remaining_minutes "$end_time")
                    echo "‚ö†Ô∏è  Schedule '$schedule_name' should be active!"
                    echo "‚è∞ Should run until: $end_time ($((remaining / 60))h $((remaining % 60))m left)"
                    echo "üí° LaunchAgent will automatically start scheduled blocks"
                else
                    echo "üí° Ready to start a new block"
                fi
            else
                echo "üí° Ready to start a new block"
            fi
    fi
}

# Detailed information
cmd_info() {
    if ! init_selfcontrol_cli; then
        die "Failed to initialize SelfControl CLI"
    fi

    echo "üìä SelfControl CLI Information"
    echo "=============================="
    echo ""

    # Version info
    echo "Version: $SELFCONTROL_CLI_VERSION"
    echo "SelfControl.app: $([ -x "$SELFCONTROL_CLI_PATH" ] && echo "‚úÖ Available" || echo "‚ùå Not found")"
    echo ""

    # Current status
    echo "Current Status:"
    cmd_status
    echo ""

    # Configuration info
    if [[ -f "$SCHEDULE_CONFIG" ]]; then
        echo "Configuration: ‚úÖ Found"
        local schedule_count
        schedule_count=$(grep -c '"name"' "$SCHEDULE_CONFIG" 2>/dev/null || echo "0")
        echo "Schedules configured: $schedule_count"
    else
        echo "Configuration: ‚ùå Not found"
        echo "Run 'selfcontrol-cli init' to create default configuration"
    fi
    echo ""

    # Log info
    if [[ -f "$SCHEDULE_LOG" ]]; then
        echo "Log file: ‚úÖ Found ($(wc -l < "$SCHEDULE_LOG") lines)"
    else
        echo "Log file: ‚ùå Not found"
    fi
}

# Start manual block
cmd_start() {
    local minutes="${1:-120}"
    local blocklist_file="$HOME/.config/selfcontrol-cli/blocklist.selfcontrol"

    if ! init_selfcontrol_cli; then
        die "Failed to initialize SelfControl CLI"
    fi

    # Check if already running
    if is_selfcontrol_running; then
        echo "‚ö†Ô∏è  SelfControl is already running"
        echo "Use 'selfcontrol-cli status' to see remaining time"
        exit 1
    fi

    # Validate minutes
    if ! echo "$minutes" | grep -qE '^[0-9]+(\.[0-9]+)?$'; then
        die "Invalid minutes format: $minutes"
    fi

    # Check if blocklist exists
    if [[ ! -f "$blocklist_file" ]]; then
        die "Blocklist file not found. Run 'selfcontrol-cli init' to create default configuration."
    fi

    # Calculate end date
    local minutes_to_add=$minutes
    # minutes_to_add is already in minutes
    local end_date
    end_date=$(date -v +${minutes_to_add}M '+%Y-%m-%d %H:%M:%S')

    echo "üöÄ Starting SelfControl block..."
    # Display duration in a clear format
    if [[ $minutes -lt 60 ]]; then
        echo "Duration: $minutes minutes"
    elif [[ $minutes -eq 60 ]]; then
        echo "Duration: 1 hour"
    else
        local hours_display
        hours_display=$(echo "scale=1; $minutes / 60" | bc)
        echo "Duration: $hours_display hours"
    fi
    echo "Ends at: $end_date"
    echo ""

    # Start block
    start_selfcontrol_block "$minutes" "$blocklist_file"

    echo "‚úÖ Block started successfully!"
    echo "Use 'selfcontrol-cli status' to check remaining time"
}

# Schedule management commands
cmd_schedule() {
    local subcommand="${1:-list}"
    shift || true

    case "$subcommand" in
        "list")
            echo "üìÖ SelfControl Scheduled Blocks"
            echo ""
            echo "üïê Current time: $(date '+%A, %B %d - %H:%M')"
            echo ""

            if [[ ! -f "$SCHEDULE_CONFIG" ]]; then
                echo "‚ùå No configuration found. Run 'selfcontrol-cli init' first."
                return 1
            fi

            local config
            if ! config=$(load_schedule_config); then
                echo "‚ùå Failed to load configuration"
                return 1
            fi

            # Extract schedules array using python for better JSON parsing
            local schedules
            schedules=$(echo "$config" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    schedules = data.get('schedules', [])
    for schedule in schedules:
        print(json.dumps(schedule))
except:
    pass
")

            if [[ -z "$schedules" ]]; then
                echo "No schedules configured."
                return 0
            fi

            # Display each schedule
            echo "$schedules" | while read -r schedule; do
                local name enabled start_time end_time days description
                name=$(json_get_value "$schedule" "name")
                enabled=$(json_get_value "$schedule" "enabled" "false")
                start_time=$(json_get_value "$schedule" "start_time")
                end_time=$(json_get_value "$schedule" "end_time")
                days=$(json_get_array "$schedule" "days")
                description=$(json_get_value "$schedule" "description" "")

                echo "üìã $name"
                if [[ -n "$description" ]]; then
                    echo "   Description: $description"
                fi
                echo "   Status: $([ "$enabled" == "true" ] && echo "‚úÖ Enabled" || echo "‚ùå Disabled")"
                echo "   Time: $start_time - $end_time"
                echo "   Days: $(echo "$days" | tr '\n' ' ')"
                echo ""
            done
            ;;
        "status")
            echo "üìä Schedule Status"
            echo "=================="
            echo ""

            local active_schedule
            if active_schedule=$(get_active_schedule 2>/dev/null); then
                local schedule_name
                schedule_name=$(json_get_value "$active_schedule" "name" "unknown")
                echo "üéØ Active schedule: $schedule_name"
            else
                echo "üéØ No active schedule"
            fi
            ;;
        "enable")
            local schedule_name="$1"
            if [[ -z "$schedule_name" ]]; then
                echo "‚ùå Please specify a schedule name"
                echo "Usage: selfcontrol-cli schedule enable <name>"
                return 1
            fi

            if update_schedule_status "$schedule_name" "true"; then
                echo "‚úÖ Enabled schedule: $schedule_name"
            else
                echo "‚ùå Failed to enable schedule: $schedule_name"
                return 1
            fi
            ;;
        "disable")
            local schedule_name="$1"
            if [[ -z "$schedule_name" ]]; then
                echo "‚ùå Please specify a schedule name"
                echo "Usage: selfcontrol-cli schedule disable <name>"
                return 1
            fi

            if update_schedule_status "$schedule_name" "false"; then
                echo "‚úÖ Disabled schedule: $schedule_name"
            else
                echo "‚ùå Failed to disable schedule: $schedule_name"
                return 1
            fi
            ;;
        "reload")
            echo "üîÑ Reloading configuration..."
            if load_schedule_config >/dev/null; then
                echo "‚úÖ Configuration reloaded successfully"
            else
                echo "‚ùå Failed to reload configuration"
                return 1
            fi
            ;;
        "test")
            test_schedule_logic
            ;;
        *)
            echo "‚ùå Unknown schedule command: $subcommand"
            echo "Available commands: list, status, enable, disable, reload, test"
            return 1
            ;;
    esac
}

# Service management commands (LaunchAgent)
cmd_service() {
    local subcommand="${1:-status}"
    shift || true

    # Check if LaunchAgent functions are available
    if ! command -v launchagent_main >/dev/null 2>&1; then
        echo "‚ùå LaunchAgent management not available"
        echo "Please update your installation or check that launchagent.sh is properly installed."
        return 1
    fi

    launchagent_main "$subcommand" "$@"
}

# =============================================================================
# NEW COMMANDS (v3.1.0)
# =============================================================================

# Live status monitoring
cmd_status_live() {
    local refresh_interval="${1:-5}"

    if ! init_selfcontrol_cli; then
        die "Failed to initialize SelfControl CLI"
    fi

    echo "üî¥ Live Status Monitor - SelfControl CLI v$SELFCONTROL_CLI_VERSION"
    echo "‚è∞ Refresh: ${refresh_interval}s | Press Ctrl+C to exit"
    echo "============================================================"

    # Handle Ctrl+C gracefully
    trap 'echo -e "\nüëã Live monitoring stopped"; exit 0' INT

    while true; do
        # Clear screen and show header
        clear
        echo "üî¥ SelfControl CLI - Live Status Monitor"
        echo "============================================================"
        echo "üìÖ $(date '+%Y-%m-%d %H:%M:%S (%A)')"
        echo "‚è∞ Refresh: ${refresh_interval}s | Press Ctrl+C to exit"
        echo ""

        # Show current status
        echo "üìä Current Status:"
        echo "------------------"
        cmd_status
        echo ""

        # Show recent schedule activity
        echo "üìã Recent LaunchAgent Activity (last 5 entries):"
        echo "-------------------------------------------------"
        if [[ -f "$SCHEDULE_LOG" ]]; then
            tail -5 "$SCHEDULE_LOG" | while IFS= read -r line; do
                echo "   $line"
            done
        else
            echo "   No schedule log found"
        fi

        echo ""
        echo "üîÑ Next update in ${refresh_interval}s..."

        # Wait for refresh interval
        sleep "$refresh_interval"
    done
}

# Debug mode
cmd_debug() {
    if ! init_selfcontrol_cli; then
        die "Failed to initialize SelfControl CLI"
    fi

    echo "üêõ SelfControl CLI Debug Information"
    echo "====================================="
    echo ""

    # System information
    echo "üñ•Ô∏è  System Information:"
    echo "   macOS Version: $(sw_vers -productVersion)"
    echo "   Bash Version: $BASH_VERSION"
    echo "   User: $(whoami)"
    echo "   HOME: $HOME"
    echo ""

    # File paths and permissions
    echo "üìÅ File Paths & Permissions:"
    echo "   Script Directory: $SCRIPT_DIR"
    echo "   Root Directory: $ROOT_DIR"
    echo "   Lib Directory: $LIB_DIR"
    echo "   Config File: $SCHEDULE_CONFIG"
    echo "   Log File: $SCHEDULE_LOG"
    echo ""

    # Check file existence and permissions
    for file in "$SCHEDULE_CONFIG" "$SCHEDULE_LOG" "$SELFCONTROL_CLI_PATH"; do
        if [[ -f "$file" ]]; then
            echo "   ‚úÖ $file ($(ls -la "$file" | cut -d' ' -f1,3,4))"
        else
            echo "   ‚ùå $file (not found)"
        fi
    done
    echo ""

    # SelfControl.app integration
    echo "üîó SelfControl.app Integration:"
    if [[ -x "$SELFCONTROL_CLI_PATH" ]]; then
        echo "   ‚úÖ SelfControl CLI available"
        echo "   Version: $(/Applications/SelfControl.app/Contents/MacOS/selfcontrol-cli version 2>/dev/null || echo 'Unknown')"
    else
        echo "   ‚ùå SelfControl CLI not found"
    fi
    echo ""

    # LaunchAgent status
    echo "ü§ñ LaunchAgent Status:"
    local launchagent_plist="$HOME/Library/LaunchAgents/com.selfcontrol.cli.scheduler.plist"
    if [[ -f "$launchagent_plist" ]]; then
        echo "   ‚úÖ LaunchAgent plist exists"
        if launchctl list | grep -q "com.selfcontrol.cli.scheduler"; then
            echo "   ‚úÖ LaunchAgent loaded"
        else
            echo "   ‚ùå LaunchAgent not loaded"
        fi
    else
        echo "   ‚ùå LaunchAgent plist not found"
    fi
    echo ""

    # Configuration validation
    echo "‚öôÔ∏è  Configuration Validation:"
    if [[ -f "$SCHEDULE_CONFIG" ]]; then
        if python3 -m json.tool "$SCHEDULE_CONFIG" >/dev/null 2>&1; then
            echo "   ‚úÖ Configuration JSON is valid"
            local schedule_count
            schedule_count=$(grep -c '"name"' "$SCHEDULE_CONFIG" 2>/dev/null || echo "0")
            echo "   üìã Schedules configured: $schedule_count"
        else
            echo "   ‚ùå Configuration JSON is invalid"
        fi
    else
        echo "   ‚ùå Configuration file not found"
    fi
    echo ""

    # Sudo permissions check
    echo "üîê Sudo Permissions:"
    local sudoers_file="/etc/sudoers.d/selfcontrol-cli"
    if [[ -f "$sudoers_file" ]]; then
        echo "   ‚úÖ Sudoers file exists"
        if sudo -n true 2>/dev/null; then
            echo "   ‚úÖ Sudo works without password"
        else
            echo "   ‚ùå Sudo requires password"
        fi
    else
        echo "   ‚ùå Sudoers file not found"
    fi
}

# Log following
cmd_logs() {
    local follow=false
    local lines=20

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --follow|-f)
                follow=true
                shift
                ;;
            --lines|-n)
                lines="$2"
                shift 2
                ;;
            *)
                lines="$1"
                shift
                ;;
        esac
    done

    if ! init_selfcontrol_cli; then
        die "Failed to initialize SelfControl CLI"
    fi

    echo "üìã SelfControl CLI Logs"
    echo "======================="

    if [[ ! -f "$SCHEDULE_LOG" ]]; then
        echo "‚ùå No log file found: $SCHEDULE_LOG"
        return 1
    fi

    if [[ "$follow" == "true" ]]; then
        echo "üîÑ Following log file (Ctrl+C to exit)..."
        echo "File: $SCHEDULE_LOG"
        echo ""
        tail -f "$SCHEDULE_LOG"
    else
        echo "üìÑ Last $lines lines:"
        echo "File: $SCHEDULE_LOG"
        echo ""
        tail -n "$lines" "$SCHEDULE_LOG"
    fi
}

# Configuration validation
cmd_validate() {
    if ! init_selfcontrol_cli; then
        die "Failed to initialize SelfControl CLI"
    fi

    echo "‚úÖ SelfControl CLI Configuration Validation"
    echo "==========================================="
    echo ""

    local errors=0

    # Check configuration file
    echo "üìÑ Configuration File:"
    if [[ -f "$SCHEDULE_CONFIG" ]]; then
        echo "   ‚úÖ File exists: $SCHEDULE_CONFIG"

        # Validate JSON syntax
        if python3 -m json.tool "$SCHEDULE_CONFIG" >/dev/null 2>&1; then
            echo "   ‚úÖ JSON syntax is valid"

            # Validate structure
            local config
            if config=$(load_schedule_config 2>/dev/null); then
                echo "   ‚úÖ Configuration structure is valid"

                # Check schedules
                local schedule_count
                schedule_count=$(echo "$config" | python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print(len(data.get('schedules', [])))
except:
    print('0')
" 2>/dev/null)
                echo "   üìã Schedules found: $schedule_count"
            else
                echo "   ‚ùå Configuration structure is invalid"
                ((errors++))
            fi
        else
            echo "   ‚ùå JSON syntax is invalid"
            ((errors++))
        fi
    else
        echo "   ‚ùå Configuration file not found"
        ((errors++))
    fi
    echo ""

    # Check blocklist files
    echo "üìã Blocklist Files:"
    if [[ -f "$SCHEDULE_CONFIG" ]]; then
        local blocklists
        blocklists=$(python3 -c "
import json
try:
    with open('$SCHEDULE_CONFIG') as f:
        data = json.load(f)
        for name, filename in data.get('blocklists', {}).items():
            print(f'{name}:{filename}')
except:
    pass
" 2>/dev/null)

        if [[ -n "$blocklists" ]]; then
            while IFS=':' read -r name filename; do
                local blocklist_path="$HOME/.config/selfcontrol-cli/$filename"
                if [[ -f "$blocklist_path" ]]; then
                    if plutil -lint "$blocklist_path" >/dev/null 2>&1; then
                        echo "   ‚úÖ $name: $filename (valid plist)"
                    else
                        echo "   ‚ùå $name: $filename (invalid plist)"
                        ((errors++))
                    fi
                else
                    echo "   ‚ùå $name: $filename (file not found)"
                    ((errors++))
                fi
            done <<< "$blocklists"
        else
            echo "   ‚ö†Ô∏è  No blocklists configured"
        fi
    fi
    echo ""

    # Summary
    echo "üìä Validation Summary:"
    if [[ $errors -eq 0 ]]; then
        echo "   ‚úÖ All checks passed! Configuration is valid."
        return 0
    else
        echo "   ‚ùå Found $errors error(s). Please fix the issues above."
        return 1
    fi
}

# =============================================================================
# MAIN DISPATCHER
# =============================================================================

# Main command dispatcher
main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        "help"|"-h"|"--help")
            cmd_help
            ;;
        "version"|"-v"|"--version")
            cmd_version
            ;;
        "init")
            cmd_init
            ;;
        "status"|"st")
            if [[ "${1:-}" == "--live" ]]; then
                cmd_status_live
            else
                cmd_status
            fi
            ;;
        "info")
            cmd_info
            ;;
        "start")
            cmd_start "${1:-}"
            ;;
        "schedule"|"sched")
            cmd_schedule "$@"
            ;;
        "service"|"svc")
            cmd_service "$@"
            ;;
        "debug")
            cmd_debug
            ;;
        "logs")
            cmd_logs "$@"
            ;;
        "validate")
            cmd_validate
            ;;
        "_launchagent_check")
            # Internal command called by LaunchAgent - not documented for users
            check_and_execute_schedules
            ;;
        *)
            echo "‚ùå Unknown command: $command"
            echo ""
            echo "Use 'selfcontrol-cli help' for usage information."
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
